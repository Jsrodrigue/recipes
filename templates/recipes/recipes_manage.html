{% extends 'base.html' %} {% block content %}

<!-- Hamburguer btn for moviles, refactored my menu with gpt to make more responsive -->
<div class="mb-2 d-md-none">
  <button
    class="btn btn-primary"
    type="button"
    data-bs-toggle="offcanvas"
    data-bs-target="#offcanvasMenu"
    aria-controls="offcanvasMenu"
  >
    â˜° Menu
  </button>
</div>

<div class="d-flex">
  <!-- Sidebar in desktop -->
  <div
    class="offcanvas offcanvas-start d-md-flex flex-column flex-shrink-0 p-3 bg-light"
    tabindex="-1"
    id="offcanvasMenu"
    aria-labelledby="offcanvasMenuLabel"
    style="width: 200px"
  >
    <h5 class="offcanvas-title d-md-none" id="offcanvasMenuLabel">Menu</h5>
    <button
      type="button"
      class="btn-close d-md-none mb-3"
      data-bs-dismiss="offcanvas"
      aria-label="Close"
    ></button>

    <button
      class="btn text-start text-dark menu-btn my-2"
      data-url="{{ url_for('recipes.index') }}"
      name="myRecipesBtn"
    >
      My Recipes
    </button>
    <button
      class="btn text-start text-dark menu-btn my-2"
      data-url="{{ url_for('recipes.index') }}"
      name="exploreBtn"
    >
      Explore
    </button>
    <button
      class="btn text-start text-dark menu-btn my-2"
      data-url="{{ url_for('recipes.new') }}"
      name="newRecipeBtn"
    >
      New Recipe
    </button>
  </div>

  <!-- Dynamic content to inject when an option in menu is clicked -->
  <div id="content-container" class="mt-4 px-3" style="flex-grow: 1"></div>
</div>

<script>
  // Global variables to store ingredient data
  let ingredients = [];
  let ingredientsList = null;
  let hiddenList = null;

  //-------------------------------------------------------------------
  // --------AJAX to load content when a menu option is clicked--------
  // -------I tried to do by myself and used gpt to debug my code------
  //-------------------------------------------------------------------
  
  const buttons = document.querySelectorAll(".menu-btn");
  buttons.forEach((button) => {
    button.addEventListener("click", async () => {
      let url = button.dataset.url;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Error loading content");
        const html = await response.text();

        document.getElementById("content-container").innerHTML = html;

        // call AFTER injecting HTML so elements exist in DOM
        setupIngredientHandlers(button.getAttribute('name'));

      } catch (error) {
        console.error(error);
        alert("Failed to load content");
      }

      // Close the menu in mobiles
      const offcanvas = bootstrap.Offcanvas.getInstance(
        document.getElementById("offcanvasMenu")
      );
      if (offcanvas) offcanvas.hide();
    });
  });

  // Function to get references of the tags after loaded the content
  function setupIngredientHandlers(name){
    if (name == 'newRecipeBtn'){
      // Get references AFTER content is in the DOM
      ingredientsList = document.getElementById("ingredients-list");
      hiddenList = document.getElementById("ingredients");
      ingredients = [];
    }
  }

  //-------------------------------------------------------------------------------------
  //--------Script to add ingredients dynamically in the new recipe form-----------------
  // -------I tried to do by myself and used gpt to debug my code------------------------
  //-------------------------------------------------------------------------------------


  //Function to normalize the format of ingredients by capitalizing and cleaning spaces
  function capitalizeAndClean(str) {
    let cleaned = str.trim();
    cleaned = cleaned.replace(/\s+/g, " ");
    if (cleaned.length === 0) return "";
    return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
  }

  //Function to update the ingredients in the UI
  function updateIngredients() {
    ingredientsList.innerHTML = '';

    ingredients.forEach((ing, index) => {
      const div = document.createElement('div');
      div.className = 'd-flex justify-content-between align-items-center mb-1';

      div.innerHTML = `
        <div>${index + 1}. ${ing.ingredient} - ${ing.quantity}</div>
        <button type="button" class="btn btn-sm btn-danger">x</button>
      `;

      div.querySelector('button').addEventListener('click', () => {
        ingredients.splice(index, 1);
        updateIngredients();
      });

      ingredientsList.appendChild(div);
    });

    hiddenList.value = JSON.stringify(ingredients);
  }

  //Function to add ingredient when clicked
  function addIngredient() {
    const ingredient = capitalizeAndClean(prompt("Ingredient:"));
    if (!ingredient) return;

    const quantity = prompt("Quantity:");
    if (!quantity) return;

    ingredients.push({ ingredient: ingredient, quantity: quantity });
    console.log('ingredients:', ingredients);
    updateIngredients();
  }
</script>

{% endblock %}
