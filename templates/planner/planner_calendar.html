{% extends 'base.html' %} {% block title %}Meal Planner{% endblock %} {% block
head %}
<!-- FullCalendar CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/main.min.css"
  rel="stylesheet"
/>
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.18/index.global.min.js"></script>
{% endblock %} {% block content %}
<div class="container mt-4">
  <h2>My Meal Planner</h2>
  <div id="calendar"></div>
</div>

<!-- Modal to show and manage meals for a selected date -->
<div
  class="modal fade"
  id="mealModal"
  tabindex="-1"
  aria-labelledby="mealModalLabel"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mealModalLabel">
          Recipes for <span id="modalDate"></span>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="mealsList"></div>
        <hr />
        <button id="addMealBtn" class="btn btn-primary">Add programed recipe</button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");

    // Initialize FullCalendar
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      height: "auto",
      events: "{{ url_for('planner.calendar_events') }}",
      dateClick: function (info) {
        openMealModal(info.dateStr);
      },
    });

    calendar.render();

    // Function to open modal and load meals for a selected date
    async function openMealModal(dateStr) {
      document.getElementById("modalDate").textContent = dateStr;
      const mealsList = document.getElementById("mealsList");
      mealsList.innerHTML = "Loading...";

      const mealModal = new bootstrap.Modal(
        document.getElementById("mealModal")
      );
      mealModal.show();

      try {
        const mealsUrl =
          "{{ url_for('planner.meals', date_str='__DATE__') }}".replace(
            "__DATE__",
            dateStr
          );
        const response = await fetch(mealsUrl);
        const data = await response.json();
        
        if (data.length === 0) {
          mealsList.innerHTML = "<p>No recipes scheduled for this day.</p>";
        } else {
          mealsList.innerHTML = "";

          // Inject meals for de day
          data.forEach((meal) => {
            const div = document.createElement("div");
            div.className =
              "d-flex justify-content-between align-items-center mb-2";
            div.innerHTML = `
            <div>
              <strong><a class="nav-link" href="/recipes/${meal.recipe_id}">${meal.recipe_title}</a></strong>
               (${meal.meal_type})
            </div>
            <button class="btn btn-danger btn-sm btn-delete" data-id="${meal.id}">Delete</button>
          `;
            mealsList.appendChild(div);
          });

          // Add listeners to delete buttons
          document.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.addEventListener("click", async function () {
              const planId = this.dataset.id;
              const deleteUrl = `/planner/delete/${planId}`;

              if (!planId || planId === "undefined") {
                alert("Error: Plan ID is undefined.");
                return;
              }

              if (
                confirm(
                  "Are you sure you want to delete this scheduled recipe?"
                )
              ) {
                try {
                  const resp = await fetch(deleteUrl, {
                    method: "DELETE",
                    headers: {
                      "X-Requested-With": "XMLHttpRequest",
                    },
                  });
                  console.log("Response from DELETE request:", resp);
                  if (resp.ok) {
                    this.parentElement.remove();
                    calendar.refetchEvents(); // Refresh calendar
                  } else {
                    console.error("Deletion failed. Status:", resp.status);
                    alert("Error deleting the recipe.");
                  }
                } catch (err) {
                  console.error("Fetch error during deletion:", err);
                  alert("Error deleting the recipe.");
                }
              }
            });
          });
        }
      } catch (err) {
        console.error("Error fetching meals:", err);
        mealsList.innerHTML = "<p>Error loading recipes.</p>";
      }
    }

    // Redirect to add meal page
    document
      .getElementById("addMealBtn")
      .addEventListener("click", function () {
        const date = document.getElementById("modalDate").textContent;
        window.location.href = `/planner/add?date=${date}`;
      });
  });
</script>
{% endblock %}
